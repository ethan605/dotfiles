#!/usr/bin/env bash
set -euxo pipefail

BEMENU_OPTS=(
  --ignorecase
  --prompt bemenu
  --grab
  --line-height 30
  --tb '#282a36'
  --tf '#ff6ac1'
  --hb '#ff6ac1'
  --hf '#282a36'
  --nb '#282a36'
  --nf '#eff0eb'
  --fb '#282a36'
  --ff '#eff0eb'
  --fn 'pango:Cantarell 14'
)

function emoji() {
  # Based on https://github.com/dln/wofi-emoji
  cat "$XDG_DATA_HOME/emoji.txt" \
    | bemenu "${BEMENU_OPTS[@]}" --prompt emoji \
    | cut -d ' ' -f 1 \
    | tr -d '\n' \
    | wl-copy
}

function calc() {
  # Based on https://github.com/barbuk/menu-qalc
  # which is based on https://github.com/onespaceman/menu-calc
  local answer=""
  local opt_copy=" Copy "
  local opt_clear=" Clear "

  if [ -n "${1-}" ]; then
    answer=$(echo "$1" \
      | qalc +u8 -color=never -terse \
      | awk '!/^>/ && !/^$/ {gsub(/^[ \t]+|[ \t]+$/, "", $0); print}'
    )
  fi

  local action=$(echo -e "$opt_copy\n$opt_clear" \
    | bemenu "${BEMENU_OPTS[@]}" --prompt "= $answer"
  )

  case $action in
    "$opt_copy") echo -n "$answer" | wl-copy ;;
    "$opt_clear") $0 calc ;;
    "") ;;
    *) $0 calc "$action" "$@" ;;
  esac
}

function pass() {
  local backend_opts="bemenu ${BEMENU_OPTS[@]} --prompt pass"
  tessen --backend="$backend_opts" --action=copy
}

function quickphrase() {
  cat /usr/share/fcitx5/data/quickphrase.d/emoji-eac.mb \
    | sed -r 's/:(.*):\s*(.*)/\2 \1/gi; s/_/ /gi' \
    | bemenu "${BEMENU_OPTS[@]}" --prompt quickphrase \
    | cut -d ' ' -f 1 \
    | tr -d '\n' \
    | wl-copy
}

function main() {
  local sub_command=${1-}
  shift

  case "$sub_command" in
    launcher) bemenu "${BEMENU_OPTS[@]}" --prompt "ðŸ”Ž" ;;
    calc) calc "$@" ;;
    emoji) emoji ;;
    pass) pass ;;
    quickphrase) quickphrase ;;
    *) ;;
  esac
}

main "$@"
